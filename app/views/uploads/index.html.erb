<% content_for :head do %>
<%= stylesheet_link_tag 'uploads' -%>
<% end -%>
<h1>File Listing</h1>

<%
def curr_dir
    session[controller_name] ? session[controller_name][:directory] || '/' : '/'
end
def child(p)
    curr = curr_dir.split('/')
    curr = [''] if curr.empty?
    path = p.split('/')
    (path - curr).first
end
-%>
<p>Current directory: <%=h curr_dir %></p>
<% if curr_dir != '/' %>
  <p><%= link_to('Parent directory', :cd => :up) %></p>
<% end -%>
<% if @uploads.blank? -%>
    <p>There are no uploaded files.</p>
<% else -%>
<table class="files">
  <tr>
    <th>Filename</th>
    <th>Description</th>
    <th>Size</th>
    <th>Content type</th>
    <th>Created at</th>
  </tr>
<% shown = Set.new -%>
<% @uploads.each do |upload| -%>
  <% if upload.directory == curr_dir -%>
    <tr>
      <td><%= link_to(h(upload.filename), upload_get_path(upload)) %></td>
      <td><%=h upload.description %></td>
      <td><%=h upload.size %></td>
      <td><%=h upload.content_type %></td>
      <td><%=h upload.created_at %></td>
      <td><%= link_to 'Show', upload %></td>
      <td><%= link_to 'Edit', edit_upload_path(upload) %></td>
      <%#td><%= link_to 'Destroy', upload, :confirm => 'Are you sure?', :method => :delete ></td%>
    </tr>
  <% else -%>
    <% child_dir = child(upload.directory) -%>
    <% unless shown.include?(child_dir) -%>
      <% shown << child_dir -%>
      <tr>
        <td><%= link_to(h(child_dir), {:cd => child_dir}, {:class => :directory}) %></td>
      </tr>
    <% end -%>
  <% end -%>
<% end -%>
</table>

<% end -%>

<p>
  <%= link_to 'Upload a file', new_upload_path %>
</p>

<p>
  <% form_tag '', :method => 'GET' do %>
    <%= label_tag 'Add directory'%>
    <%= text_field_tag :cd%>
    <%= submit_tag 'Go'%>
  <% end -%>
</p>
